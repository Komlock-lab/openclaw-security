---
date: 2026-02-28
category: built-in-security
severity: info
source: GitHub公式リポジトリ (openclaw/openclaw)、公式ドキュメント
verified: true
---

# OpenClaw 組み込みセキュリティコマンド調査

## 調査概要

OpenClaw v2026.2.26 に搭載されている組み込みセキュリティコマンド（`openclaw doctor` および `openclaw security audit`）の機能、制限事項、サードパーティツールとの比較をまとめた。

**情報ソース:** GitHub公式リポジトリ（`openclaw/openclaw`）の `docs/gateway/doctor.md`、`docs/gateway/security/index.md`、`docs/cli/security.md`、`docs/cli/doctor.md` から取得。全て実在する公式ドキュメントで検証済み。

---

## 1. `openclaw doctor` コマンド

### 概要
ヘルスチェック・設定修復・マイグレーションを行う包括的な修復ツール。アップデート後やトラブルシューティングの際に実行する。

### 実行方法

```bash
openclaw doctor              # 対話的に実行
openclaw doctor --yes        # デフォルトの修復を自動承認
openclaw doctor --repair     # 推奨修復を自動適用
openclaw doctor --repair --force  # アグレッシブな修復も適用
openclaw doctor --non-interactive # 安全なマイグレーションのみ非対話的に
openclaw doctor --deep       # システムサービスの追加インストールもスキャン
```

### チェック・修復項目（全19カテゴリ）

| # | カテゴリ | 内容 |
|---|---------|------|
| 0 | アップデート | gitインストール時にfetch/rebase/buildを提案 |
| 1 | 設定正規化 | レガシー設定値を現在のスキーマに正規化 |
| 2 | レガシーキー移行 | 非推奨キーの自動マイグレーション（例: `routing.allowFrom` → `channels.whatsapp.allowFrom`） |
| 2b | OpenCode Zen警告 | `models.providers.opencode` の手動オーバーライドを警告 |
| 3 | ディスクレイアウト移行 | セッション・エージェントディレクトリ・WhatsApp認証の移行 |
| 4 | 状態整合性チェック | ステートディレクトリ欠損、パーミッション、トランスクリプト不整合、JSOLNの1行問題 |
| 5 | モデル認証ヘルスチェック | OAuthの有効期限チェック、トークンリフレッシュ、クールダウン/無効化状態の報告 |
| 6 | フックモデル検証 | `hooks.gmail.model` のモデル参照を検証 |
| 7 | サンドボックスイメージ修復 | Dockerイメージの存在確認と構築提案 |
| 8 | Gatewayサービスマイグレーション | レガシーサービスの検出・削除・再インストール |
| 9 | **セキュリティ警告** | **DMポリシーのオープン設定を警告** |
| 10 | systemd linger | Linux systemdのユーザーサービス持続化チェック |
| 11 | スキルステータス | eligible/missing/blockedスキルのサマリー |
| 12 | Gateway認証チェック | `gateway.auth` の欠如を警告、トークン生成を提案 |
| 13 | Gatewayヘルスチェック | ヘルスチェック＋再起動の提案 |
| 14 | チャネルステータス | チャネルプローブの実行と警告の表示 |
| 15 | Supervisor設定監査 | launchd/systemd/schtasksの設定整合性チェック＋修復 |
| 16 | Gatewayランタイム診断 | PID、終了ステータス、ポート衝突の診断 |
| 17 | ランタイムベストプラクティス | Bun使用警告、バージョンマネージャパス警告 |
| 18 | 設定書き込み＋メタデータ | 変更の永続化とウィザードメタデータの更新 |
| 19 | ワークスペースヒント | メモリシステムとgitバックアップの提案 |

### セキュリティに関連するチェック（重要）

- **設定ファイルのパーミッション**: `~/.openclaw/openclaw.json` が group/world readable なら chmod 600 を提案
- **DMポリシーの警告**: allowlistなしのオープンDMポリシーを検出
- **Gateway認証トークン**: `gateway.auth.token` 未設定時に警告・自動生成を提案
- **OAuth有効期限**: 期限切れ/期限近いOAuthトークンの検出とリフレッシュ

---

## 2. `openclaw security audit` コマンド

### 概要
設定・ファイルパーミッション・セキュリティベストプラクティスに特化したセキュリティ監査ツール。doctorよりセキュリティ観点に特化。

### 実行方法

```bash
openclaw security audit            # 基本監査
openclaw security audit --deep     # 深い監査
openclaw security audit --fix      # 安全な自動修復
openclaw security audit --json     # JSON出力（CI/ポリシーチェック向け）
openclaw security audit --fix --json  # 修復＋レポート
```

### 検出項目（確認済み）

| カテゴリ | チェック内容 |
|---------|------------|
| **DM/セッション分離** | 複数DMの送信者がメインセッションを共有している場合に警告。`session.dmScope="per-channel-peer"` を推奨 |
| **信頼モデル警告** | 設定がマルチユーザー受信を示唆する場合（オープンDM/グループポリシー、ワイルドカード送信者等）に警告 |
| **小モデル+未サンドボックス** | 300Bパラメータ以下のモデルがサンドボックスなし＋Web/ブラウザツール有効の場合に警告 |
| **Webhookセッションキー** | `hooks.defaultSessionKey` 未設定、リクエスト `sessionKey` オーバーライド有効の場合に警告 |
| **サンドボックス設定不整合** | サンドボックスモードOFFでDocker設定が残っている場合に警告 |
| **ノードコマンドパターン** | `gateway.nodes.denyCommands` に無効なパターン的エントリがある場合に警告 |
| **危険なノードコマンド** | `gateway.nodes.allowCommands` で危険なコマンドを明示的に許可している場合に警告 |
| **ツールプロファイル上書き** | グローバル `tools.profile="minimal"` がエージェント単位で上書きされている場合に警告 |
| **オープングループのツール露出** | オープングループがサンドボックス/ワークスペースガードなしでランタイム/FSツールを露出している場合に警告 |
| **プラグインツール到達性** | 拡張プラグインツールが緩いツールポリシー下で到達可能な場合に警告 |
| **IP偽装リスク** | `gateway.allowRealIpFallback=true` でヘッダー偽装リスクがある場合に警告 |
| **mDNSメタデータ漏洩** | `discovery.mdns.mode="full"` でメタデータがmDNS TXTレコードから漏洩する場合に警告 |
| **サンドボックスブラウザネットワーク** | Docker `bridge` ネットワークで `cdpSourceRange` 未設定の場合に警告 |
| **危険なDockerネットワーク** | `host` や `container:*` ネームスペースジョインモードの場合に警告 |
| **ブラウザコンテナのハッシュラベル** | 古い/欠損したハッシュラベルのコンテナを検出 |
| **npmプラグインピン止め** | 未ピン止め、整合性メタデータ欠損、バージョンドリフトを警告 |
| **チャネル許可リストの可変ID** | Discord/Slack等で名前/メール/タグ（可変）に依存している場合に安定IDの使用を推奨 |
| **Gateway認証なし** | `gateway.auth.mode="none"` でHTTP APIが無認証でアクセス可能な場合に警告 |
| **dangerousプレフィックス設定** | `dangerous`/`dangerously` プレフィックスのbreak-glass設定の有効化を通知 |

### `--fix` で自動修正される項目

| 修正内容 | 詳細 |
|---------|------|
| グループポリシー変更 | `groupPolicy="open"` → `groupPolicy="allowlist"` に変更 |
| ログ秘匿化設定 | `logging.redactSensitive` を `"off"` → `"tools"` に変更 |
| パーミッション強化 | ステート/設定ファイル、認証情報ファイル（`credentials/*.json`、`auth-profiles.json`、`sessions.json`、セッション `*.jsonl`）のパーミッション修正 |

### `--fix` で修正されない項目（重要な制限）

- トークン/パスワード/APIキーのローテーション
- ツールの無効化（`gateway`、`cron`、`exec` 等）
- Gatewayのバインド/認証/ネットワーク露出設定の変更
- プラグイン/スキルの削除・書き換え

---

## 3. `doctor` と `security audit` の違い

| 項目 | `openclaw doctor` | `openclaw security audit` |
|------|-------------------|---------------------------|
| **目的** | 総合的なヘルスチェック・修復 | セキュリティ特化の監査 |
| **マイグレーション** | レガシー設定・ディスクレイアウトの移行 | なし |
| **セキュリティ** | 基本的なDMポリシー・認証トークンの警告 | 詳細なセキュリティベストプラクティス監査 |
| **サービス管理** | launchd/systemd/schtasksの管理・修復 | なし |
| **自動修復** | 設定正規化、パーミッション、サービス再構築 | グループポリシー、ログ秘匿化、パーミッション |
| **JSON出力** | なし | `--json` でCI/CD統合可能 |
| **推奨実行タイミング** | アップデート後、問題発生時 | 定期的、設定変更後、ネットワーク露出変更後 |

---

## 4. 組み込みコマンドの制限事項

### 4.1 セキュリティモデルの前提

- **シングルユーザー/パーソナルアシスタントモデルが前提**: マルチテナント・敵対的ユーザー環境は対象外
- doctorもsecurity auditも、信頼境界が正しく設定されている前提で動作する

### 4.2 検出の限界

| 限界 | 説明 |
|------|------|
| **プロンプトインジェクション攻撃** | doctorもsecurity auditもプロンプトインジェクション攻撃のテストや検出を行わない |
| **実行時の攻撃検出** | 静的な設定チェックのみで、実行時の攻撃パターンを検出しない |
| **スキルのコードレビュー** | インストールされたスキルのコード内容の安全性はチェックしない |
| **ネットワーク攻撃のシミュレーション** | 実際のペネトレーションテストは行わない |
| **LLMの挙動テスト** | モデルが攻撃に対してどう反応するかのテストは行わない |
| **トークンローテーション** | `--fix` でもトークンの自動ローテーションは行わない |
| **ツール無効化** | 危険なツール（exec等）の自動無効化は行わない（運用者の判断に委ねる） |
| **マルチテナント監査** | 信頼境界の分離が正しいかどうかの監査は対象外 |

### 4.3 セキュリティ対策で未カバーの領域

公式Threat Model（MITRE ATLASベース）から判明した、組み込みツールでカバーされない高リスク領域:

1. **直接プロンプトインジェクション（T-EXEC-001）**: Critical - 検出のみ、ブロックなし
2. **間接プロンプトインジェクション（T-EXEC-002）**: High - XMLタグラッピングのみ、LLMが無視する可能性
3. **ツール引数インジェクション（T-EXEC-003）**: High - ユーザー判断に依存
4. **exec承認バイパス（T-EXEC-004）**: High - コマンドサニタイゼーションなし
5. **悪意あるスキルのインストール（T-PERSIST-001）**: Critical - サンドボックスなし、レビュー限定的
6. **トークン盗難（T-ACCESS-003）**: High - トークンが平文で保存

---

## 5. サードパーティツール（SecureClaw等）との比較

### 組み込みツールの強み

- **公式サポート**: OpenClawチームが直接メンテナンス、バージョンアップに追従
- **設定の深い理解**: 内部設定スキーマに完全にアクセス可能
- **マイグレーション機能**: レガシー設定の自動移行（サードパーティには不可能）
- **サービス管理統合**: launchd/systemd/schtasksとの直接連携
- **CI/CD統合**: `--json` でパイプラインに組み込み可能
- **無料・同梱**: 追加インストール不要

### 組み込みツールの弱み（サードパーティが補完すべき領域）

| 領域 | 組み込みツール | サードパーティ（SecureClaw等）が補完 |
|------|-------------|----------------------------------|
| プロンプトインジェクションテスト | 未対応 | 実際の攻撃ペイロードでテスト可能 |
| スキルコード監査 | パターンマッチのみ | 詳細なコード分析、挙動テスト |
| LLM挙動テスト | 未対応 | モデル応答の安全性テスト |
| ペネトレーションテスト | 未対応 | SSRF、認証バイパスの実テスト |
| 継続的監視 | 手動実行のみ | リアルタイム監視・アラート |
| 脆弱性データベース連携 | 限定的 | CVE/GHSA/NVDとの連携 |
| カスタムルール | 不可 | 環境固有のルール定義 |
| レポート生成 | JSON出力のみ | 詳細なレポート・ダッシュボード |

### 推奨される併用パターン

```
定期実行:
  1. openclaw doctor          → 基本ヘルスチェック・設定修復
  2. openclaw security audit  → セキュリティ設定監査
  3. サードパーティツール       → 攻撃テスト・深い脆弱性分析

設定変更時:
  1. openclaw security audit --deep --json → CI/CDでゲートチェック
  2. サードパーティツール → 変更影響の攻撃テスト

リリース前:
  1. 全組み込みチェック + サードパーティの包括スキャン
```

---

## 6. その他の組み込みセキュリティ機能

doctorとsecurity audit以外にも以下のセキュリティ関連機能がある:

| コマンド/機能 | 説明 |
|-------------|------|
| `openclaw sandbox explain` | サンドボックスの有効モード・ツールポリシーを表示 |
| `openclaw pairing approve <channel> <code>` | DMペアリングコードの承認 |
| `openclaw update --channel stable` | 安定チャネルへの切り替え |
| SSRF Protection | DNS pinning + IPブロッキング |
| Content Wrapping | 外部コンテンツをXMLタグでラップ |
| Exec Approvals | 危険なコマンドの承認フロー |
| Formal Verification | TLA+/TLCによる形式検証（別リポジトリ） |
| Threat Model (ATLAS) | MITRE ATLASベースの脅威モデル |

---

## 調査日: 2026-02-28
## 検証ステータス: 公式リポジトリのドキュメントから全て検証済み
